
> [!notion] 
> *  **通过日志的形式记录每个操作**，将redis中每个执行过的指令记录下来（只记录写指令），只允许追加文件不允许改写文件，redis在启动的时候会通过这个文件重新构建数据。也就是redis回按照文件的内容重新执行一遍指令
> * 默认情况redis是没有开启AOF的
> * 保存的文件名称为`appendonly.aof`



> [!NOTE] AOF的工作流程

![[CleanShot 2024-01-18 at 09.22.29@2x 1.png]]
1. 作为客户端产生多个命令
2. 这些命令到达redis的服务端的时候，不会立即写入的AOF文件中，会将这些命令先放入AOF缓存中。这里的AOF缓存就是内存中的一片空间，目的是为了让命令达到一定的数量的时候再一起写入的磁盘中，避免了频繁的io操作。
3.  AOF的缓冲区会根据AOF缓冲区**同步文件的三种写回策略**将命令写入磁盘的AOF文件
4. 随着AOF文件内容的增多，会根据规则进行命令的合并(**AOF重写**)，从而对AOF文件起到压缩的作用
5. 当redis服务端重启的时候会从AOF文件中加载数据


> [!NOTE] AOF缓冲区的三种写回策略
> 1. `Always`：同步写回，每个命令执行完成之后，立刻同步到磁盘
> 2. `everysec`：每秒写回，每个命令执行完成之后不会立即写回，只是先将日志写到AOF缓冲区，一秒以后再将缓冲区中的内容写入到磁盘。最多会丢失1s的数据
> 3. `no`：写将日志写入到AOF缓冲区，由操作系统决定合适写入到磁盘中


> [!NOTE] AOF相关配置
> 1. 如何开启aof
> 	修改为`appendonly yes`，默认是no，就是不开启AOF
> 1. 写回策略的修改
> 	修改`appendfsync xxx`,默认是`everysec`
> 2. aof文件的保存路径  
> 	* redis7之前的AOF文件和rdb文件是在同一个目录下
> 	* redis7之后，现在aof的文件是在`dir + appenddirname`下,其中的`dir + appenddirname`和rdb文件是在同一层级
> 		![[CleanShot 2024-01-18 at 16.48.42@2x.png]]
>
> 



> [!note] aof文件介绍
> 1. base:表示基础aof文件，一般由子进程重写产生，该文件最多只有一个
> 2. incr:该文件会存在多个，在读写的时候看，**该文件会会不断的增大，如果触发预置的条件或者手动触发了`bgrewriteaof`命令。该文件中的内容会被重写到base中，同时base和incr文件的下标会增加1**
> 3. meaifest: 用于跟踪管理这些aof





> [!important] AOF重写机制
> # 什么是AOF重写机制
> 就是启动AOF文件的内容的压缩，只保留可以恢复数据的最小的指令集。如：日志中有set k1 v1,set k1 v2,set k1 v3,那么在进行压缩之后就只会有一条set k1 v3。
> # 触发机制
> * 自动触发
> 	* 满足配置文件中的条件之后会触发
> 		![[CleanShot 2024-01-18 at 09.40.26@2x.png]]
> 		必须要**同时满足上面两个条件才会触发**
> 		* 根据上次重写后AOF的大小，判断当前的AOF是不是增长了一倍
> 		* 重写时最小的文件大小
> * 手动触发，向客户端发送`bgrewriteaof`命令



> [!example] aof重写机制的自动触发: 验证启动AOF文件内容的压缩，只保留可以恢复数据的最小指令集
> 前置配置：
> 1. 设置AOF开启
> 2. 关闭混合模式
> 3. 修改峰值为400b
> 	* `auto-aof-rewrite-percentage 100`
> 	* `auto-aof-rewrite-min-size 400b`
		  
![[CleanShot 2024-01-18 at 16.08.35@2x.png|725]]

![[CleanShot 2024-01-18 at 16.14.41@2x.png]]


> [!example] 手动触发

![[CleanShot 2024-01-18 at 16.23.54@2x.png|700]]



> [!example] AOf文件的异常恢复
> 对应的步骤2：向现存的`appendonly.aof.1.incr.aof`中的随意增加一些内容
> ![[CleanShot 2024-01-18 at 16.32.37@2x.png|325]]

![[CleanShot 2024-01-18 at 16.36.07@2x.png]]


> [!advantage] 优缺点
> # 优点
> * 可以更好的保存数据，数据不易丢失。写回策略如果是`everysec`的话，最多只会丢失1s的数据
> # 缺点
> * 相同的数据集的数据aof文件要远大于rdb文件，因此恢复速度慢于rdb
> 